<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Translator - Powered by OpenAI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c2c2d 0%, #000000 50%, #626161 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
            position: relative;
        }

        /* Fixed animated background - simpler and more stable */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background: linear-gradient(135deg, #2c2c2d 0%, #000000 50%, #626161 100%);
        }

        .background-animation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255,255,255,0.1) 1px, transparent 1px),
                radial-gradient(circle at 80% 80%, rgba(255,255,255,0.08) 1px, transparent 1px),
                radial-gradient(circle at 40% 60%, rgba(255,255,255,0.06) 1px, transparent 1px);
            animation: sparkle 4s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 4rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #ffffff, #e3f2fd, #bbdefb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGlow 3s ease-in-out infinite alternate;
            font-weight: 800;
            letter-spacing: -2px;
        }

        @keyframes titleGlow {
            0% { filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
            100% { filter: drop-shadow(0 0 20px rgba(255,255,255,0.6)); }
        }

        h2 {
            font-size: 2rem;
            margin-bottom: 2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.4rem;
            margin-bottom: 3rem;
            opacity: 0.95;
            font-weight: 300;
            line-height: 1.6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .powered-by {
            font-size: 0.95rem;
            opacity: 0.8;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, rgba(255,255,255,0.15), rgba(255,255,255,0.25));
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            display: inline-block;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .btn {
            background: linear-gradient(45deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15));
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 1.2rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            margin: 0.8rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            min-width: 220px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.95rem;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.8s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: linear-gradient(45deg, rgba(255,255,255,0.35), rgba(255,255,255,0.25));
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn.primary {
            background: linear-gradient(45deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15));
            border: 2px solid rgba(255,255,255,0.4);
            box-shadow: 0 5px 15px rgba(255,255,255,0.3);
        }

        .btn.primary:hover {
            background: linear-gradient(45deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15));
            box-shadow: 0 10px 30px rgba(255,255,255,0.3);
            transform: translateY(-4px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            margin: 2rem 0;
        }

        input, select {
            padding: 1rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(10px);
            min-width: 300px;
            text-align: center;
            margin: 0.5rem;
        }

        input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
            padding-right: 3rem;
        }

        select option {
            background: #764ba2;
            color: white;
        }

        .room-code {
            background: rgba(255,255,255,0.3);
            padding: 1.5rem;
            border-radius: 20px;
            margin: 2rem 0;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 0.2em;
            backdrop-filter: blur(10px);
        }

        .status {
            background: rgba(255,255,255,0.2);
            padding: 1rem 2rem;
            border-radius: 25px;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
        }

        .status.listening {
            background: rgba(76, 175, 80, 0.3);
            animation: pulse 2s infinite;
        }

        .status.recording {
            background: rgba(244, 67, 54, 0.3);
            animation: pulse 1s infinite;
        }

        .translation-box {
            background: rgba(255,255,255,0.2);
            padding: 2rem;
            border-radius: 20px;
            margin: 2rem 0;
            min-height: 200px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            line-height: 1.6;
            text-align: left;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .back-btn {
            position: absolute;
            top: 2rem;
            left: 2rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .error {
            background: rgba(244, 67, 54, 0.3);
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .success {
            background: rgba(76, 175, 80, 0.3);
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        .info {
            background: linear-gradient(45deg, rgba(33, 150, 243, 0.25), rgba(63, 81, 181, 0.25));
            padding: 1.5rem 2rem;
            border-radius: 20px;
            margin: 2rem auto;
            border-left: 4px solid #2196f3;
            font-size: 0.95rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(33, 150, 243, 0.3);
            max-width: 600px;
            line-height: 1.6;
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.2);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .feature-card {
            background: linear-gradient(45deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
            padding: 2rem;
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.4s ease;
            text-align: left;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            background: linear-gradient(45deg, rgba(255,255,255,0.2), rgba(255,255,255,0.12));
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .feature-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .feature-desc {
            font-size: 0.95rem;
            opacity: 0.9;
            line-height: 1.5;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin: 3rem 0;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            padding: 1.5rem 2rem;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            min-width: 150px;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            display: block;
            background: linear-gradient(45deg, #ffffff, #e3f2fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
            
            input, select {
                min-width: 250px;
            }
            
            .room-code {
                font-size: 1.5rem;
            }

            .features-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .stats-bar {
                gap: 1.5rem;
            }

            .stat-item {
                min-width: 120px;
                padding: 1rem 1.5rem;
            }

            .stat-number {
                font-size: 2rem;
            }

            .btn {
                min-width: 180px;
                padding: 1rem 2rem;
                font-size: 0.9rem;
            }

            /* Disable heavy animations on mobile */
            .background-animation::before {
                animation: none;
                opacity: 0.3;
            }
        }
    </style>
</head>
<body>
    <!-- Home Page -->
    <div id="home" class="page active">
        <!-- Fixed animated background -->
        <div class="background-animation"></div>

        <div class="container">
            <h1>üåç Live Translator</h1>
            <div class="powered-by">Made by - Keyaan Husain</div>
            <p class="subtitle">Break language barriers in real-time with AI-powered live translation. Host speaks, audience gets instant translations with natural voice in their language.</p>
            
            <!-- Main Action Buttons -->
            <div class="controls">
                <button class="btn" onclick="showPage('host-setup')">
                    üé§ Host Session
                </button>
                <button class="btn" onclick="showPage('audience-join')">
                    üë• Join Session
                </button>
            </div>

            <!-- Features Grid -->
            <div class="features-grid">
                <div class="feature-card">
                    <span class="feature-icon">üéØ</span>
                    <div class="feature-title">Smart Voice Detection</div>
                    <div class="feature-desc">No false translations!</div>
                </div>
                <div class="feature-card">
                    <span class="feature-icon">‚ö°</span>
                    <div class="feature-title">Real-Time Processing</div>
                    <div class="feature-desc">1-2 second delay.</div>
                </div>
                <div class="feature-card">
                    <span class="feature-icon">üåê</span>
                    <div class="feature-title">99+ Languages</div>
                    <div class="feature-desc">Supports Urdu, Spanish, French, Arabic, Chinese, and many more!</div>
                </div>
                <div class="feature-card">
                    <span class="feature-icon">üîä</span>
                    <div class="feature-title">Natural AI Voices</div>
                    <div class="feature-desc">Premium text-to-speech that sound natural.</div>
                </div>
                <div class="feature-card">
                    <span class="feature-icon">üõ°Ô∏è</span>
                    <div class="feature-title">Privacy First</div>
                    <div class="feature-desc">No recordings stored. Audio is processed in real-time and immediately discarded.</div>
                </div>
                <div class="feature-card">
                    <span class="feature-icon">üì±</span>
                    <div class="feature-title">Any Device</div>
                    <div class="feature-desc">Works on desktop, tablet, and mobile. No app downloads required - just open in browser.</div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-number">99+</span>
                    <span class="stat-label">Languages</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">2-3s</span>
                    <span class="stat-label">Delay</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">‚àû</span>
                    <span class="stat-label">Sessions</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">0</span>
                    <span class="stat-label">Setup Time</span>
                </div>
            </div>

            <!-- Enhanced Info -->
            <div class="info">
                <strong>Perfect For:</strong> International meetings, educational content, family conversations, business presentations, live events, and connecting people across language barriers. Simply create a room, share the code, and start speaking!
            </div>
        </div>
    </div>

    <!-- Host Setup Page -->
    <div id="host-setup" class="page">
        <button class="back-btn" onclick="showPage('home')">‚Üê Back</button>
        <div class="container">
            <h2>üé§ Host a Translation Session</h2>
            <p class="subtitle">Create a room and start speaking - your audience will receive live translations</p>
            <button class="btn primary" onclick="createRoom()" id="create-room-btn">Create Room</button>
            <div id="host-room-info" style="display: none;">
                <div class="room-code">Room Code: <span id="host-room-code"></span></div>
                <p>Share this code with your audience</p>
                <div class="controls">
                    <button class="btn primary" onclick="startHosting()" id="start-btn">Start Speaking</button>
                    <button class="btn" onclick="stopHosting()" id="stop-btn" style="display: none;">‚èπÔ∏è Stop</button>
                </div>
                <div id="host-status" class="status">Ready to start</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audience Join Page -->
    <div id="audience-join" class="page">
        <button class="back-btn" onclick="showPage('home')">‚Üê Back</button>
        <div class="container">
            <h2>üë• Join Translation Session</h2>
            <p class="subtitle">Enter the room code provided by your host</p>
            <div class="input-group">
                <input type="text" id="room-code-input" placeholder="Enter Room Code" maxlength="6" style="text-transform: uppercase;">
            </div>
            <button class="btn primary" onclick="joinRoom()">Join Room</button>
            <div id="join-error"></div>
        </div>
    </div>

    <!-- Language Selection Page -->
    <div id="language-select" class="page">
        <button class="back-btn" onclick="showPage('audience-join')">‚Üê Back</button>
        <div class="container">
            <h2>üåê Select Your Language</h2>
            <p class="subtitle">Choose the language you want to receive translations in</p>
            <div class="input-group">
                <select id="language-dropdown">
                    <option value="">Select Language</option>
                    <option value="ur">üáµüá∞ Urdu (ÿßÿ±ÿØŸà)</option>
                    <option value="es">üá™üá∏ Spanish (Espa√±ol)</option>
                    <option value="fr">üá´üá∑ French (Fran√ßais)</option>
                    <option value="de">üá©üá™ German (Deutsch)</option>
                    <option value="it">üáÆüáπ Italian (Italiano)</option>
                    <option value="pt">üáßüá∑ Portuguese (Portugu√™s)</option>
                    <option value="ru">üá∑üá∫ Russian (–†—É—Å—Å–∫–∏–π)</option>
                    <option value="ja">üáØüáµ Japanese (Êó•Êú¨Ë™û)</option>
                    <option value="ko">üá∞üá∑ Korean (ÌïúÍµ≠Ïñ¥)</option>
                    <option value="zh">üá®üá≥ Chinese (‰∏≠Êñá)</option>
                    <option value="ar">üá∏üá¶ Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
                    <option value="hi">üáÆüá≥ Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                    <option value="bn">üáßüá© Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
                    <option value="tr">üáπüá∑ Turkish (T√ºrk√ße)</option>
                    <option value="pl">üáµüá± Polish (Polski)</option>
                    <option value="nl">üá≥üá± Dutch (Nederlands)</option>
                    <option value="sv">üá∏üá™ Swedish (Svenska)</option>
                    <option value="da">üá©üá∞ Danish (Dansk)</option>
                    <option value="no">üá≥üá¥ Norwegian (Norsk)</option>
                    <option value="fi">üá´üáÆ Finnish (Suomi)</option>
                </select>
            </div>
            <button class="btn primary" onclick="startListening()">Start Listening</button>
            <div class="info">
                üéß <strong>OpenAI TTS</strong> will provide natural-sounding voice in your selected language!
            </div>
        </div>
    </div>

    <!-- Audience Listening Page -->
    <div id="audience-listening" class="page">
        <button class="back-btn" onclick="showPage('language-select')">‚Üê Back</button>
        <div class="container">
            <h2>üéß Live Translation</h2>
            <div id="audience-status" class="status">Connecting to session...</div>
            <div class="translation-box" id="translation-display">
                Waiting for host to start speaking...
            </div>
            <div class="controls">
                <button class="btn" onclick="toggleAudio()" id="audio-toggle">üîä Audio On</button>
                <button class="btn" onclick="showPage('language-select')">Change Language</button>
            </div>
            <div class="info">
                ‚ö° Smart Processing: Voice detection ‚Üí Sentence completion ‚Üí Translation with 2-3s delay
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentRoom = null;
        let isHost = false;
        let isListening = false;
        let websocket = null;
        let selectedLanguage = '';
        let audioEnabled = true;
        let currentAudio = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingInterval = null;

        const API_BASE = window.location.origin;

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // Audio Recording Setup for Host with Smart Processing
        async function initAudioRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    } 
                });
                
                // Use better audio format for speech recognition
                const options = { mimeType: 'audio/webm;codecs=opus' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'audio/webm';
                }
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'audio/mp4';
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    if (audioChunks.length > 0) {
                        const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                        audioChunks = [];
                        sendAudioToServer(audioBlob);
                    }
                };
                
                return true;
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Microphone access required for hosting. Please allow microphone access and try again.');
                return false;
            }
        }

        // Send audio data to server for smart processing
        async function sendAudioToServer(audioBlob) {
            if (!websocket || !isHost || !isListening) return;
            
            try {
                const reader = new FileReader();
                reader.onload = function() {
                    const base64Audio = reader.result.split(',')[1];
                    websocket.send(JSON.stringify({
                        type: 'audio_data',
                        audio: base64Audio
                    }));
                };
                reader.readAsDataURL(audioBlob);
            } catch (error) {
                console.error('Error sending audio:', error);
            }
        }

        // WebSocket Connection
        function connectWebSocket(roomCode, userType, language = null) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${roomCode}`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function() {
                console.log('WebSocket connected');
                websocket.send(JSON.stringify({
                    type: userType,
                    language: language
                }));
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            websocket.onclose = function() {
                console.log('WebSocket disconnected');
                if (isListening) {
                    updateHostStatus('Connection lost - trying to reconnect...');
                    updateAudienceStatus('Connection lost - trying to reconnect...');
                    
                    // Try to reconnect after 3 seconds
                    setTimeout(() => {
                        if (currentRoom) {
                            connectWebSocket(currentRoom, isHost ? 'host' : 'audience', selectedLanguage);
                        }
                    }, 3000);
                }
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'connected':
                    console.log('Connected to room:', data.room_code);
                    if (data.user_type === 'host') {
                        updateHostStatus('Connected - Ready to start speaking!');
                    } else {
                        updateAudienceStatus('Connected - Waiting for host to start...');
                    }
                    break;
                    
                case 'translation':
                    displayTranslation(data.translated);
                    if (audioEnabled && data.audio) {
                        playAudioFromBase64(data.audio);
                    }
                    break;
                    
                case 'session_started':
                    updateAudienceStatus('üéôÔ∏è Host is speaking - listening for translations...');
                    break;
                    
                case 'session_stopped':
                    updateAudienceStatus('‚è∏Ô∏è Host has stopped speaking');
                    break;
                    
                case 'pong':
                    // Keep-alive response
                    break;
            }
        }

        // Play audio from base64 data
        function playAudioFromBase64(base64Audio) {
            if (!audioEnabled) return;
            
            try {
                const audioData = `data:audio/mp3;base64,${base64Audio}`;
                const audio = new Audio(audioData);
                
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                currentAudio = audio;
                audio.play().catch(e => {
                    console.error('Audio play error:', e);
                    // Try again with a slight delay
                    setTimeout(() => audio.play().catch(() => {}), 100);
                });
            } catch (error) {
                console.error('Error playing audio:', error);
            }
        }

        // Host Functions
        async function createRoom() {
            const btn = document.getElementById('create-room-btn');
            btn.disabled = true;
            btn.textContent = 'Creating Room...';
            
            try {
                const response = await fetch(`${API_BASE}/create-room`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create room');
                }
                
                const data = await response.json();
                currentRoom = data.room_code;
                
                document.getElementById('host-room-code').textContent = currentRoom;
                document.getElementById('host-room-info').style.display = 'block';
                isHost = true;
                
                // Connect to WebSocket
                connectWebSocket(currentRoom, 'host');
                
                // Initialize audio recording
                const audioReady = await initAudioRecording();
                if (!audioReady) {
                    updateHostStatus('‚ùå Microphone setup failed - please refresh and try again');
                }
                
            } catch (error) {
                console.error('Error creating room:', error);
                alert('Failed to create room. Please check your connection and try again.');
                updateHostStatus('‚ùå Failed to create room');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Room';
            }
        }

        async function startHosting() {
            if (!mediaRecorder) {
                alert('Audio recording not available. Please refresh and allow microphone access.');
                return;
            }

            isListening = true;
            
            // Notify server that session has started
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ type: 'start_session' }));
            }
            
            // Start continuous recording in chunks
            startContinuousRecording();
            
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-block';
            updateHostStatus('üéôÔ∏è Recording... Speak naturally with pauses between sentences!');
        }

        function startContinuousRecording() {
            if (!isListening || !mediaRecorder) return;
            
            try {
                mediaRecorder.start();
                
                // Record in 1-second chunks for better real-time processing
                recordingInterval = setInterval(() => {
                    if (isListening && mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        
                        // Restart recording immediately for continuous capture
                        setTimeout(() => {
                            if (isListening && mediaRecorder && mediaRecorder.state === 'inactive') {
                                mediaRecorder.start();
                            }
                        }, 50); // Very short delay for seamless recording
                    } else if (!isListening) {
                        clearInterval(recordingInterval);
                    }
                }, 1000); // 1-second chunks for responsive processing
                
            } catch (error) {
                console.error('Recording error:', error);
                updateHostStatus('‚ùå Recording error - please try again');
            }
        }

        function stopHosting() {
            isListening = false;
            
            if (recordingInterval) {
                clearInterval(recordingInterval);
                recordingInterval = null;
            }
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            
            // Notify server that session has stopped
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ type: 'stop_session' }));
            }
            
            document.getElementById('start-btn').style.display = 'inline-block';
            document.getElementById('stop-btn').style.display = 'none';
            updateHostStatus('‚èπÔ∏è Stopped - Ready to start again');
        }

        function updateHostStatus(message) {
            const statusEl = document.getElementById('host-status');
            statusEl.textContent = message;
            statusEl.className = isListening ? 'status recording' : 'status';
        }

        // Audience Functions
        async function joinRoom() {
            const roomCode = document.getElementById('room-code-input').value.toUpperCase().trim();
            const errorDiv = document.getElementById('join-error');
            
            if (!roomCode) {
                errorDiv.innerHTML = '<div class="error">Please enter a room code</div>';
                return;
            }
            
            if (roomCode.length !== 6) {
                errorDiv.innerHTML = '<div class="error">Room code must be 6 characters</div>';
                return;
            }
            
            try {
                // Check if room exists
                const response = await fetch(`${API_BASE}/room/${roomCode}/status`);
                
                if (!response.ok) {
                    errorDiv.innerHTML = '<div class="error">Room not found. Please check the code and try again.</div>';
                    return;
                }
                
                const roomData = await response.json();
                currentRoom = roomCode;
                
                if (!roomData.host_connected) {
                    errorDiv.innerHTML = '<div class="error">Host is not connected to this room yet. Please wait for the host to create the session.</div>';
                    return;
                }
                
                errorDiv.innerHTML = '<div class="success">‚úÖ Room found! Select your language.</div>';
                
                setTimeout(() => {
                    showPage('language-select');
                }, 1000);
                
            } catch (error) {
                console.error('Error joining room:', error);
                errorDiv.innerHTML = '<div class="error">Failed to join room. Please check your connection and try again.</div>';
            }
        }

        function startListening() {
            selectedLanguage = document.getElementById('language-dropdown').value;
            
            if (!selectedLanguage) {
                alert('Please select a language');
                return;
            }
            
            // Connect to WebSocket as audience member
            connectWebSocket(currentRoom, 'audience', selectedLanguage);
            
            showPage('audience-listening');
            updateAudienceStatus('üîÑ Connecting to session...');
        }

        function updateAudienceStatus(message) {
            const statusEl = document.getElementById('audience-status');
            statusEl.textContent = message;
            statusEl.className = message.includes('listening') ? 'status listening' : 'status';
        }

        function displayTranslation(text) {
            const displayEl = document.getElementById('translation-display');
            displayEl.textContent = text;
            
            // Add a subtle animation when new translation appears
            displayEl.style.transform = 'scale(0.98)';
            setTimeout(() => {
                displayEl.style.transform = 'scale(1)';
            }, 100);
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            const btn = document.getElementById('audio-toggle');
            btn.textContent = audioEnabled ? 'üîä Audio On' : 'üîá Audio Off';
            
            if (!audioEnabled && currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
        }

        // Keep WebSocket connection alive
        function keepAlive() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ type: 'ping' }));
            }
        }

        // Auto-uppercase room code input
        document.addEventListener('DOMContentLoaded', function() {
            const roomInput = document.getElementById('room-code-input');
            if (roomInput) {
                roomInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }
            
            // Keep connection alive every 30 seconds
            setInterval(keepAlive, 30000);
        });

        // Handle page unload - cleanup connections
        window.addEventListener('beforeunload', function() {
            if (isListening) {
                stopHosting();
            }
            if (websocket) {
                websocket.close();
            }
        });

        // Handle browser back button
        window.addEventListener('popstate', function() {
            showPage('home');
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Space bar to start/stop hosting (only on host page)
            if (event.code === 'Space' && document.getElementById('host-setup').classList.contains('active')) {
                event.preventDefault();
                if (isHost && currentRoom) {
                    if (isListening) {
                        stopHosting();
                    } else {
                        startHosting();
                    }
                }
            }
            
            // Enter to join room or start listening
            if (event.code === 'Enter') {
                if (document.getElementById('audience-join').classList.contains('active')) {
                    joinRoom();
                } else if (document.getElementById('language-select').classList.contains('active')) {
                    startListening();
                }
            }
        });
    </script>
</body>
</html>